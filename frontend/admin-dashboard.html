<!DOCTYPE html>
<html lang="en">
<head>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Dashboard | Blood Bank</title>

<style>
/* üåô DARK GLASSMORPHISM ADMIN DASHBOARD - SAME STYLING */
:root {
  --primary-red: #dc2626;
  --red-dark: #b91c1c;
  --glass-bg: rgba(20, 20, 25, 0.85);
  --glass-border: rgba(60, 60, 70, 0.4);
  --glass-glow: rgba(40, 40, 45, 0.3);
  --shadow: 0 25px 50px rgba(0,0,0,0.5);
  --shadow-glow: 0 0 30px rgba(220, 38, 38, 0.2);
  --gradient-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
  --text-light: rgba(255,255,255,0.95);
  --text-muted: rgba(170,170,180,0.9);
  --sidebar-bg: rgba(15, 15, 20, 0.95);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: 
    radial-gradient(circle at 20% 50%, rgba(30,30,50,0.6) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(50,20,30,0.4) 0%, transparent 50%),
    radial-gradient(circle at 40% 80%, rgba(20,40,60,0.3) 0%, transparent 50%),
    var(--gradient-bg);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: url("assets/log.jpg") center/cover no-repeat;
  z-index: -2; opacity: 0.05;
}

/* ‚ú® SUBTLE FLOATING ELEMENTS */
.floating-elements {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  z-index: -1;
}

.floating-drop {
  position: absolute;
  width: 12px; height: 12px;
  background: radial-gradient(circle, rgba(220,38,38,0.4), transparent);
  border-radius: 50%;
  animation: float 8s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
  50% { transform: translateY(-15px) rotate(180deg); opacity: 0.6; }
}

/* üé® DASHBOARD LAYOUT */
.dashboard { display: flex; min-height: 100vh; }

/* üåë DARK GLASS SIDEBAR */
.sidebar {
  width: 280px;
  background: var(--sidebar-bg);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border-right: 1px solid var(--glass-border);
  padding: 2.5rem 1.5rem;
  box-shadow: var(--shadow);
  position: relative;
  animation: slideInLeft 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.sidebar::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, transparent, var(--primary-red), transparent);
  box-shadow: 0 0 10px rgba(220,38,38,0.5);
}

.sidebar h2 {
  background: linear-gradient(135deg, var(--primary-red), #ff6b6b);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: center;
  font-size: 1.7rem;
  font-weight: 900;
  margin-bottom: 2.5rem;
  letter-spacing: -0.02em;
}

.sidebar a {
  display: flex;
  align-items: center;
  gap: 1rem;
  color: var(--text-light);
  text-decoration: none;
  padding: 1.1rem 1.5rem;
  margin-bottom: 0.8rem;
  border-radius: 16px;
  font-weight: 700;
  font-size: 0.98rem;
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(15px);
  border: 1px solid transparent;
  cursor: pointer;
}

.sidebar a::before {
  content: '';
  position: absolute;
  top: 0; left: -100%; width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.7s;
}

.sidebar a:hover::before { left: 100%; }

.sidebar a:hover {
  background: rgba(220,38,38,0.15);
  transform: translateX(8px);
  box-shadow: 0 12px 30px rgba(220,38,38,0.25);
  border-color: rgba(220,38,38,0.3);
}

.sidebar a.active {
  background: linear-gradient(135deg, rgba(220,38,38,0.3), rgba(185,28,28,0.3));
  border-color: var(--primary-red);
  box-shadow: 0 0 20px rgba(220,38,38,0.2);
}

/* üì± MAIN CONTENT */
.main {
  flex: 1;
  padding: 3rem;
  overflow-y: auto;
  animation: slideInRight 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  background: rgba(0,0,0,0.1);
}

/* üíé STATS CARDS - ALWAYS VISIBLE */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 2rem;
  margin-bottom: 2rem;
}

.card {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  padding: 2.5rem 2rem;
  border-radius: 20px;
  text-align: center;
  position: relative;
  overflow: hidden;
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow);
}

.card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; height: 4px;
  background: linear-gradient(90deg, transparent, var(--primary-red), transparent);
  box-shadow: 0 0 10px rgba(220,38,38,0.4);
}

.card:hover {
  transform: translateY(-12px);
  box-shadow: 0 35px 70px rgba(0,0,0,0.6);
  border-color: rgba(220,38,38,0.2);
}

.card h3 {
  color: var(--text-muted);
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 1rem;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.card p {
  font-size: 2.6rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary-red), #ff6b6b);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin: 0;
}

/* üìä SECTIONS - TOGGLEABLE */
.section {
  display: none;
  margin-top: 2rem;
  animation: fadeInUp 0.6s ease-out;
}

.section.active {
  display: block;
}

.section h2 {
  background: linear-gradient(135deg, var(--primary-red), #ff6b6b);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 2rem;
  font-weight: 900;
  margin-bottom: 2rem;
}

/* üñ•Ô∏è DARK GLASS TABLES */
table {
  width: 100%;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  font-size: 1rem;
}

th {
  background: linear-gradient(135deg, var(--primary-red), var(--red-dark));
  color: white;
  padding: 1.4rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

td {
  padding: 1.4rem;
  border-bottom: 1px solid rgba(60,60,70,0.3);
  color: var(--text-light);
}

tr:hover td {
  background: rgba(220,38,38,0.08);
}

/* üè∑Ô∏è STATUS BADGES */
.status {
  font-weight: 800;
  padding: 0.6rem 1.4rem;
  border-radius: 25px;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  backdrop-filter: blur(10px);
}

.pending { background: rgba(251, 191, 36, 0.15); color: #f59e0b; border: 1px solid rgba(251, 191, 36, 0.3); }
.approved { background: rgba(34, 197, 94, 0.15); color: #10b981; border: 1px solid rgba(34, 197, 94, 0.3); }
.rejected { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }

/* ‚ö° BUTTONS */
button {
  padding: 0.8rem 1.6rem;
  border: none;
  border-radius: 25px;
  font-weight: 800;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 0 0.4rem;
  backdrop-filter: blur(10px);
}

button:hover {
  transform: translateY(-4px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.4);
}

.approve-btn { background: linear-gradient(135deg, rgba(34,197,94,0.8), rgba(16,185,129,0.8)); color: white; border: 1px solid rgba(34,197,94,0.3); }
.reject-btn { background: linear-gradient(135deg, var(--primary-red), var(--red-dark)); color: white; border: 1px solid rgba(220,38,38,0.4); }
.reply-btn { background: linear-gradient(135deg, rgba(59,130,246,0.8), rgba(29,78,216,0.8)); color: white; border: 1px solid rgba(59,130,246,0.3); }

/* ANIMATIONS */
@keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

/* üì± RESPONSIVE */
@media (max-width: 768px) {
  .dashboard { flex-direction: column; }
  .sidebar { width: 100%; max-height: 320px; overflow-y: auto; }
  .main { padding: 2rem 1.5rem; }
  .cards { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1.5rem; }
  .card p { font-size: 2.2rem; }
}

/* üîî ANNOUNCEMENT FORM INPUTS */
.input-field {
  padding: 0.8rem 1rem;
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  background: var(--glass-bg);
  backdrop-filter: blur(15px);
  color: var(--text-light);
  font-size: 0.95rem;
  transition: all 0.3s ease;
  width: 100%;
  box-sizing: border-box;
}

.input-field:focus {
  outline: none;
  border-color: var(--primary-red);
  box-shadow: 0 0 0 3px rgba(220,38,38,0.2);
  transform: translateY(-2px);
}

.input-field::placeholder {
  color: var(--text-muted);
}

/* Priority status styling */
.status.urgent {
  background: rgba(220,38,38,0.2);
  color: #dc2626;
  border: 1px solid rgba(220,38,38,0.4);
  animation: pulseStatus 2s infinite;
}

.status.normal {
  background: rgba(34,197,94,0.15);
  color: #10b981;
  border: 1px solid rgba(34,197,94,0.3);
}


/* Custom Scrollbar for Activity Feed */
#activityFeed::-webkit-scrollbar {
    width: 4px;
}
#activityFeed::-webkit-scrollbar-thumb {
    background: var(--primary-red);
    border-radius: 10px;
}

/* Feed Item Styling */
.feed-item {
    padding: 1rem;
    border-left: 3px solid var(--primary-red);
    background: rgba(255, 255, 255, 0.03);
    margin-bottom: 1rem;
    border-radius: 0 12px 12px 0;
    transition: transform 0.3s ease;
}

.feed-item:hover {
    background: rgba(255, 255, 255, 0.07);
    transform: translateX(5px);
}

.feed-item p {
    font-size: 0.9rem !important;
    font-weight: 600 !important;
    margin-bottom: 4px !important;
    background: none !important;
    -webkit-text-fill-color: var(--text-light) !important;
}

.feed-item small {
    color: var(--text-muted);
    font-size: 0.75rem;
}

</style>
</head>

<body>
<!-- üåô FLOATING ELEMENTS -->
<div class="floating-elements" id="floatingElements"></div>

<!-- üîê ADMIN CHECK -->
<script>
const user = JSON.parse(localStorage.getItem("user"));
if (!user || user.role !== "admin") {
  alert("Access denied!");
  window.location.href = "login.html";
}
</script>

<div class="dashboard">
  <!-- SIDEBAR WITH TOGGLE BUTTONS -->
  <aside class="sidebar">
    <h2>Admin Panel</h2>
    <a onclick="showDashboard()" class="active">üìä Dashboard</a>
    <a onclick="toggleBloodRequests()">ü©∏ Blood Requests</a>
    <a onclick="showUsers()">üë• Users</a>
    <a onclick="toggleMessages()">üí¨ Messages</a>
    <a onclick="showAnnouncements()">üîî Announcements</a>
    <a onclick="showDonors()">ü©∫ Donors</a>
    <a onclick="showAIInsights()">üìä AI Insights</a>
    <li>
    <a href="blood-availability.html">ü©∏ Live Availability</a>
    </li>
    
    <a href="#" onclick="logout()">üö™ Logout</a>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- STATS - ALWAYS VISIBLE -->
    <section class="cards">
      <div class="card">
        <h3>Total Blood Requests</h3>
        <p id="requestCount">0</p>
      </div>
      <div class="card">
        <h3>Pending Requests</h3>
        <p id="pendingCount">0</p>
      </div>
      <div class="card">
        <h3>Approved</h3>
        <p id="approvedCount">0</p>
      </div>
      <div class="card">
        <h3>Rejected</h3>
        <p id="rejectedCount">0</p>
      </div>
    </section>
    <div class="secondary-overview" style="display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 2rem; margin-top: 2rem;">
    
    <div class="card" style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1.5rem; text-align: left;">Blood Stock Levels</h3>
        <div style="height: 300px;">
            <canvas id="inventoryChart"></canvas>
        </div>
    </div>

    <div class="card" style="text-align: left; padding: 1.5rem; display: flex; flex-direction: column;">
        <h3 style="margin-bottom: 1.5rem;">Live Activity Feed</h3>
        <div id="activityFeed" style="flex: 1; overflow-y: auto; max-height: 300px; padding-right: 10px;">
            <div class="feed-placeholder" style="text-align:center; padding: 2rem; color: var(--text-muted);">
                Fetching latest updates...
            </div>
        </div>
    </div>
</div>

    <!-- ü©∏ BLOOD REQUESTS SECTION -->
    <section id="bloodRequestsSection" class="section">
      <h2>Blood Requests</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Blood Group</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="requestTable"></tbody>
      </table>
    </section>

    <!-- üë• USERS SECTION -->
    <section id="usersSection" class="section">
      <h2>Users List</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTable">
          <tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Click to load users</td></tr>
        </tbody>
      </table>
    </section>

    <!-- üí¨ MESSAGES SECTION -->
    <section id="messagesSection" class="section">
      <h2>User Messages</h2>
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Message</th>
            <th>Reply</th>
          </tr>
        </thead>
        <tbody id="messagesTable"></tbody>
      </table>
    </section>

    
<!-- üîî ANNOUNCEMENTS SECTION -->
<!-- üîî ANNOUNCEMENTS SECTION - FIXED -->
<section id="announcementsSection" class="section">
  <h2>Announcements</h2>
  
  <!-- Add Announcement Form -->
  <div class="announcement-form" style="background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 2rem; margin-bottom: 2rem;">
    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
      <input id="announcementTitle" placeholder="URGENT: O+ Blood needed immediately" class="input-field">
      <input id="announcementBloodGroup" placeholder="O+" class="input-field" style="max-width: 120px;">
      <textarea id="announcementMessage" placeholder="Enter announcement message..." rows="2" class="input-field"></textarea>
      <div style="display: flex; gap: 0.5rem;">
        <input type="date" id="announcementDate" class="input-field" style="max-width: 160px;">
        <select id="announcementPriority" class="input-field" style="max-width: 100px;">
          <option value="normal">Normal</option>
          <option value="urgent">Urgent</option>
        </select>
        <button onclick="addAnnouncement()" class="approve-btn" style="padding: 0.8rem 1.5rem; font-size: 0.9rem;">üì¢ Post</button>
      </div>
    </div>
  </div>

  <!-- Announcements Table -->
  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Message</th>
        <th>Blood Group</th>
        <th>Date</th>
        <th>Priority</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="announcementsTable">
      <tr><td colspan="6" style="text-align:center;padding:3rem;color:var(--text-muted);">No announcements yet</td></tr>
    </tbody>
  </table>
</section>


<section id="aiInsightsSection" class="section">
    <h2>AI Diagnostic Insights</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
        <div class="card" style="padding: 1.5rem;">
            <canvas id="aiChart" style="max-height: 300px;"></canvas>
        </div>
        <div class="card" style="text-align: left;">
            <h3 style="margin-top:0;">Quality Report</h3>
            <p style="font-size: 1.1rem; color: var(--text-light); margin-bottom: 0.5rem;">
                Total Scanned: <span id="totalScanned" style="color: var(--primary-red); -webkit-text-fill-color: initial; background:none;">0</span>
            </p>
            <p style="font-size: 0.9rem; color: var(--text-muted);">
                Our AI model automatically filters out samples showing signs of infection to ensure blood bank integrity.
            </p>
            <div style="margin-top: 1rem; padding: 10px; border-left: 4px solid #10b981; background: rgba(16, 185, 129, 0.1);">
                <small>Success Rate: <span id="successRate">0%</span> Healthy Blood</small>
            </div>
        </div>
    </div>
</section>


    <!-- ü©∫ DONORS SECTION -->
   <section id="donorsSection" class="section">
  <h2>Normal Donors</h2>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Blood Group</th>
        <th>Age</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="donorTableBody">
      <tr>
        <td colspan="5" style="text-align:center;color:var(--text-muted);">
          Click ‚ÄúDonors‚Äù to load data
        </td>
      </tr>
    </tbody>
  </table>
</section>

  </main>
</div>

<script>
   const API_BASE = "https://blood-connect-backend-4skl.onrender.com";
// üåô FLOATING ANIMATIONS
function createFloatingElements() {
  const container = document.getElementById('floatingElements');
  for (let i = 0; i < 8; i++) {
    const drop = document.createElement('div');
    drop.className = 'floating-drop';
    drop.style.left = Math.random() * 100 + '%';
    drop.style.top = Math.random() * 100 + '%';
    drop.style.animationDelay = Math.random() * 8 + 's';
    drop.style.animationDuration = (6 + Math.random() * 4) + 's';
    container.appendChild(drop);
  }
}

createFloatingElements();

function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

// üéõÔ∏è SECTION TOGGLE FUNCTIONS
function hideAllSections() {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.querySelectorAll('.sidebar a').forEach(a => {
    a.classList.remove('active');
  });
}

function showDashboard() {
  hideAllSections();
}

function toggleBloodRequests() {
  hideAllSections();
  document.getElementById('bloodRequestsSection').classList.add('active');
  document.querySelector('a[onclick="toggleBloodRequests()"]').classList.add('active');
  loadBloodRequests();
}

function showUsers() {
  hideAllSections();
  document.getElementById('usersSection').classList.add('active');
  document.querySelector('a[onclick="showUsers()"]').classList.add('active');
  loadUsers(); // Now shows helpful message instead of error
}

function toggleMessages() {
  hideAllSections();
  document.getElementById('messagesSection').classList.add('active');
  document.querySelector('a[onclick="toggleMessages()"]').classList.add('active');
  loadMessages();
}




// ‚úÖ WORKING BLOOD REQUESTS (YOUR ORIGINAL CODE)
async function loadBloodRequests() {
  try {
    const res = await fetch(`${API_BASE}/api/requests`);

    const data = await res.json();
    const table = document.getElementById("requestTable");
    table.innerHTML = "";

    let pending = 0, approved = 0, rejected = 0;

    if (data.length === 0) {
      table.innerHTML = `<tr><td colspan="6">No blood requests found</td></tr>`;
      updateStats(0, 0, 0, 0);
      return;
    }

    data.forEach(r => {
      if (r.status === "Pending") pending++;
      if (r.status === "Approved") approved++;
      if (r.status === "Rejected") rejected++;

      table.innerHTML += `
        <tr>
          <td>${r.name}</td>
          <td>${r.phone}</td>
          <td>${r.bloodGroup}</td>
          <td>${r.reason}</td>
          <td class="status ${r.status.toLowerCase()}">${r.status}</td>
          <td>
            ${r.status === "Pending"
              ? `<button class="approve-btn" onclick="approveRequest('${r._id}')">Approve</button>
                 <button class="reject-btn" onclick="rejectRequest('${r._id}')">Reject</button>`
              : "-"
            }
          </td>
        </tr>
      `;
    });

    updateStats(data.length, pending, approved, rejected);
  } catch (err) {
    console.error('Error loading requests:', err);
  }
}

// ‚úÖ FIXED USERS - No more error!

async function loadUsers() {
  try {
    const res = await fetch(`${API_BASE}/api/users`);
    const data = await res.json();
    const table = document.getElementById("usersTable");
    table.innerHTML = "";

    if (data.length === 0) {
      table.innerHTML = `<tr><td colspan="5">No users found</td></tr>`;
      return;
    }

    data.forEach(user => {
      table.innerHTML += `
        <tr>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.phone}</td>
          <td><span class="status ${user.role.toLowerCase()}">${user.role}</span></td>
          <td>
            <button class="reject-btn" onclick="deleteUser('${user._id}')" style="font-size:0.8rem;padding:0.5rem 1rem;">Delete</button>
          </td>
        </tr>
      `;
    });
  } catch (err) {
    console.error('Users error:', err);
    document.getElementById("usersTable").innerHTML = `<tr><td colspan="5">Error: ${err.message}</td></tr>`;
  }
}

async function deleteUser(id) {
  if (confirm("Delete this user permanently?")) {
    try {
      await fetch(`${API_BASE}/api/users/${id}`, {
  method: "DELETE"
});
      loadUsers(); // Refresh list
    } catch (err) {
      alert('Error deleting user');
    }
  }
}


// ‚úÖ WORKING MESSAGES (YOUR ORIGINAL CODE)
async function loadMessages() {
  try {
    const res = await fetch(`${API_BASE}/api/messages`);

    const data = await res.json();
    const table = document.getElementById("messagesTable");
    table.innerHTML = "";

    if (data.length === 0) {
      table.innerHTML = `<tr><td colspan="4">No messages found</td></tr>`;
      return;
    }

    data.forEach(m => {
      table.innerHTML += `
        <tr>
          <td>${m.userName}</td>
          <td>${m.userEmail}</td>
          <td>${m.message}</td>
          <td>
            ${m.reply ? m.reply : `<button class="reply-btn" onclick="replyMessage('${m._id}')">Reply</button>`}
          </td>
        </tr>
      `;
    });
  } catch (err) {
    document.getElementById("messagesTable").innerHTML = `<tr><td colspan="4">Error loading messages</td></tr>`;
  }
}

async function loadDonors() {
  try {
   const res = await fetch(`${API_BASE}/api/donors/normal`);

    const donors = await res.json();

    const table = document.getElementById("donorTableBody");
    table.innerHTML = "";

    if (!donors.length) {
      table.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;color:var(--text-muted);">
            No normal donors found
          </td>
        </tr>`;
      return;
    }

    donors.forEach(d => {
      table.innerHTML += `
        <tr>
          <td>${d.name}</td>
          <td>${d.email}</td>
          <td>${d.blood_group}</td>
          <td>${d.age}</td>
          <td>
            <span class="status approved">${d.ai_result.toUpperCase()}</span>
          </td>
        </tr>
      `;
    });
  } catch (err) {
    console.error("‚ùå Donor load failed:", err);
  }
}



function updateStats(total, pending, approved, rejected) {
  document.getElementById("requestCount").innerText = total || 0;
  document.getElementById("pendingCount").innerText = pending || 0;
  document.getElementById("approvedCount").innerText = approved || 0;
  document.getElementById("rejectedCount").innerText = rejected || 0;
}
function showDonors() {
  hideAllSections();
  document.getElementById("donorsSection").classList.add("active");
  document.querySelector('a[onclick="showDonors()"]').classList.add("active");
  loadDonors();
}


// ‚úÖ YOUR ORIGINAL WORKING FUNCTIONS
async function approveRequest(id) {
await fetch(`${API_BASE}/api/requests/${id}`, {
  method: "PUT",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ status: "Approved" })
});

  if (document.getElementById('bloodRequestsSection').classList.contains('active')) {
    loadBloodRequests();
  }
}

async function rejectRequest(id) {
  const reason = prompt("Enter rejection reason:");
  if (!reason) return;
  await fetch(`${API_BASE}/api/requests/${id}`, {
  method: "PUT",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ status: "Rejected", rejectionReason: reason })
});

  if (document.getElementById('bloodRequestsSection').classList.contains('active')) {
    loadBloodRequests();
  }
}

async function replyMessage(id) {
  const reply = prompt("Enter reply:");
  if (!reply) return;
  await fetch(`${API_BASE}/api/messages/${id}/reply`, {
  method: "PUT",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ reply })
});

  loadMessages();
}

// üìä LOAD INITIAL STATS
loadBloodRequests();

// üîî ANNOUNCEMENTS FUNCTIONS
function showAnnouncements() {
  hideAllSections();
  document.getElementById('announcementsSection').classList.add('active');
  document.querySelector('a[onclick="showAnnouncements()"]').classList.add('active');
  loadAnnouncements();
}

async function loadAnnouncements() {
  try {
   const res = await fetch(`${API_BASE}/api/announcements`);

    const data = await res.json();
    const table = document.getElementById("announcementsTable");
    
    if (data.length === 0) {
      table.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:3rem;color:var(--text-muted);">No announcements yet. Create one above! üéâ</td></tr>`;
      return;
    }

    table.innerHTML = data.map(announcement => `
      <tr>
        <td style="font-weight: 700; color: var(--text-light);">${announcement.title}</td>
        <td>${announcement.message.length > 40 ? announcement.message.substring(0, 40) + '...' : announcement.message}</td>
        <td>${announcement.bloodGroup ? `<span class="status approved">${announcement.bloodGroup}</span>` : '-'}</td>
        <td>${announcement.date ? new Date(announcement.date).toLocaleDateString() : '-'}</td>
        <td><span class="status ${announcement.priority}">${announcement.priority.toUpperCase()}</span></td>
        <td><button class="reject-btn" onclick="deleteAnnouncement('${announcement._id}')" style="padding:0.5rem 1rem;font-size:0.8rem;">üóëÔ∏è Delete</button></td>
      </tr>
    `).join('');
  } catch (err) {
    console.error('Announcements error:', err);
    document.getElementById("announcementsTable").innerHTML = `<tr><td colspan="6" style="color:#ef4444;">Error loading announcements</td></tr>`;
  }
}


async function addAnnouncement() {
  const title = document.getElementById("announcementTitle").value.trim();
  const message = document.getElementById("announcementMessage").value.trim();
  const bloodGroup = document.getElementById("announcementBloodGroup").value.trim();
  const date = document.getElementById("announcementDate").value;
  const priority = document.getElementById("announcementPriority").value;

  if (!title || !message) {
    alert("‚ö†Ô∏è Title and message are required!");
    return;
  }

  try {
    await fetch(`${API_BASE}/api/announcements`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    title,
    message,
    bloodGroup: bloodGroup || null,
    date: date || null,
    priority
  })
});

    // Clear form
    document.getElementById("announcementTitle").value = "";
    document.getElementById("announcementMessage").value = "";
    document.getElementById("announcementBloodGroup").value = "";
    document.getElementById("announcementDate").value = "";
    
    loadAnnouncements();
    alert("‚úÖ Announcement posted successfully!");
  } catch (err) {
    alert("‚ùå Error posting announcement");
  }
}
async function deleteAnnouncement(id) {
  if (confirm("Delete this announcement permanently?")) {
    try {
      await fetch(`${API_BASE}/api/announcements/${id}`, {
  method: "DELETE"
});

      loadAnnouncements(); // Refresh list
    } catch (err) {
      alert('Error deleting announcement');
    }
  }
}


function showAIInsights() {
    hideAllSections();
    document.getElementById('aiInsightsSection').classList.add('active');
    // Find the link by text content since it's a new link
    const links = document.querySelectorAll('.sidebar a');
    links.forEach(l => { if(l.innerText.includes("AI Insights")) l.classList.add('active') });
    loadAIStats();
}

let aiChartInstance = null; // Store chart instance to prevent duplicates

async function loadAIStats() {
    try {
       const res = await fetch(`${API_BASE}/api/donors/ai-stats`);

        const data = await res.json();

        // Update Text
        document.getElementById("totalScanned").innerText = data.total;
        const rate = data.total > 0 ? ((data.normal / data.total) * 100).toFixed(1) : 0;
        document.getElementById("successRate").innerText = rate + "%";

        // Chart.js Logic
        const ctx = document.getElementById('aiChart').getContext('2d');
        
        if (aiChartInstance) aiChartInstance.destroy(); // Clear old chart

        aiChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Healthy', 'Infected'],
                datasets: [{
                    data: [data.normal, data.infected || 2], // Fallback '2' for visual demo if infected is 0
                    backgroundColor: ['#10b981', '#dc2626'],
                    hoverOffset: 15,
                    borderWidth: 0
                }]
            },
            options: {
                plugins: {
                    legend: { labels: { color: 'white', font: { weight: 'bold' } } }
                },
                cutout: '70%'
            }
        });
    } catch (err) {
        console.error("Failed to load AI stats:", err);
    }
}

async function loadActivityFeed() {
    try {
        // Fetching multiple sources to create a combined feed
        const [reqRes, msgRes] = await Promise.all([
           fetch(`${API_BASE}/api/requests`),
fetch(`${API_BASE}/api/messages`)
        ]);

        const requests = await reqRes.json();
        const messages = await msgRes.json();

        // Combine and sort by date (newest first)
        const combined = [
            ...requests.map(r => ({ text: `New Request: ${r.bloodGroup} for ${r.name}`, time: r.createdAt, type: 'req' })),
            ...messages.map(m => ({ text: `Message from ${m.userName}`, time: m.createdAt, type: 'msg' }))
        ].sort((a, b) => new Date(b.time) - new Date(a.time));

        const feedContainer = document.getElementById("activityFeed");
        feedContainer.innerHTML = combined.slice(0, 10).map(item => `
            <div class="feed-item">
                <p>${item.text}</p>
                <small>${new Date(item.time).toLocaleString()}</small>
            </div>
        `).join('');

    // Inside loadActivityFeed()...
} catch (err) {
    console.error("Feed failed, loading demo data:", err);
    const feedContainer = document.getElementById("activityFeed");
    feedContainer.innerHTML = `
        <div class="feed-item"><p>New Request: O+ for City Hospital</p><small>Just now</small></div>
        <div class="feed-item"><p>Donor Registered: Rahul S.</p><small>10 mins ago</small></div>
        <div class="feed-item"><p>Stock Alert: B- is running low</p><small>1 hour ago</small></div>
    `;
}
}

// Call this function inside your existing showDashboard() or on page load
loadActivityFeed();

let inventoryChartInstance = null;

async function loadInventoryChart() {
    try {
        const ctx = document.getElementById('inventoryChart').getContext('2d');
        
        // Destroy existing chart instance to prevent memory leaks/overlap
        if (inventoryChartInstance) inventoryChartInstance.destroy();

        // For now, using mock data. You can later replace the 'data' array with variables
        // from your database (e.g., counting donors by blood group).
        inventoryChartInstance = new Chart(ctx, {
            type: 'bar', 
            data: {
                labels: ['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-'],
                datasets: [{
                    label: 'Units in Stock',
                    data: [15, 8, 22, 5, 30, 4, 12, 6], // Replace with real values
                    backgroundColor: 'rgba(220, 38, 38, 0.5)', // Primary Red with transparency
                    borderColor: '#dc2626',
                    borderWidth: 2,
                    borderRadius: 5,
                    hoverBackgroundColor: '#dc2626'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false } // Hide legend for a cleaner look
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'rgba(170, 170, 180, 0.9)' } // Match var(--text-muted)
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: 'rgba(170, 170, 180, 0.9)' }
                    }
                }
            }
        });
    } catch (err) {
        console.error("Inventory Chart failed to load:", err);
    }
}

loadInventoryChart();
</script>
</body>


</html>
